<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>AWS Well-Architected Labs</title><link>https://wellarchitectedlabs.com/cost/300_labs/300_splitting_sharing_cur_access/code/</link><description>Recent content on AWS Well-Architected Labs</description><generator>Hugo -- gohugo.io</generator><lastBuildDate>Fri, 24 Apr 2020 11:16:08 -0400</lastBuildDate><atom:link href="https://wellarchitectedlabs.com/cost/300_labs/300_splitting_sharing_cur_access/code/index.xml" rel="self" type="application/rss+xml"/><item><title/><link>https://wellarchitectedlabs.com/cost/300_labs/300_splitting_sharing_cur_access/code/crawler-cfn/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://wellarchitectedlabs.com/cost/300_labs/300_splitting_sharing_cur_access/code/crawler-cfn/</guid><description>Below is a sample crawler config file. It is suggested you modify your existing file, modifications are between &amp;lsquo;***&amp;rsquo; characters.
Variables that need to be changed in the new code below:
(region): The region that contains the Lambda function (accountID): The account that contains the Lambda function AWSTemplateFormatVersion: 2010-09-09 Resources: AWSCURDatabase: Type: &amp;#39;AWS::Glue::Database&amp;#39; Properties: DatabaseInput: Name: &amp;#39;(Database Name)&amp;#39; CatalogId: !Ref AWS::AccountId AWSCURCrawlerComponentFunction: Type: &amp;#39;AWS::IAM::Role&amp;#39; Properties: AssumeRolePolicyDocument: Version: 2012-10-17 Statement: - Effect: Allow Principal: Service: - glue.</description></item><item><title/><link>https://wellarchitectedlabs.com/cost/300_labs/300_splitting_sharing_cur_access/code/iam_athena/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://wellarchitectedlabs.com/cost/300_labs/300_splitting_sharing_cur_access/code/iam_athena/</guid><description>IAM policy for access to Athena
NOTE: This Policy is to be used as a starting point only. Ensure to follow security best practices and only provide the minimum required access. You will also need to modify the and fields before use.
{
&amp;#34;Version&amp;#34;: &amp;#34;2012-10-17&amp;#34;,
&amp;#34;Statement&amp;#34;: [
{
&amp;#34;Sid&amp;#34;: &amp;#34;VisualEditor0&amp;#34;,
&amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;,
&amp;#34;Action&amp;#34;: [
&amp;#34;athena:StartQueryExecution&amp;#34;,
&amp;#34;glue:GetCrawler&amp;#34;,
&amp;#34;glue:GetDataCatalogEncryptionSettings&amp;#34;,
&amp;#34;glue:GetTableVersions&amp;#34;,
&amp;#34;glue:GetPartitions&amp;#34;,
&amp;#34;athena:GetQueryResults&amp;#34;,
&amp;#34;athena:ListWorkGroups&amp;#34;,
&amp;#34;athena:GetNamedQuery&amp;#34;,
&amp;#34;glue:GetDevEndpoint&amp;#34;,
&amp;#34;glue:GetSecurityConfiguration&amp;#34;,
&amp;#34;glue:GetResourcePolicy&amp;#34;,
&amp;#34;glue:GetTrigger&amp;#34;,
&amp;#34;glue:GetUserDefinedFunction&amp;#34;,
&amp;#34;athena:GetExecutionEngine&amp;#34;,
&amp;#34;glue:GetJobRun&amp;#34;,
&amp;#34;athena:GetExecutionEngines&amp;#34;,
&amp;#34;s3:HeadBucket&amp;#34;,
&amp;#34;glue:GetUserDefinedFunctions&amp;#34;,
&amp;#34;glue:GetClassifier&amp;#34;,
&amp;#34;s3:PutAccountPublicAccessBlock&amp;#34;,
&amp;#34;athena:GetQueryResultsStream&amp;#34;,
&amp;#34;glue:GetJobs&amp;#34;,
&amp;#34;glue:GetTables&amp;#34;,
&amp;#34;glue:GetTriggers&amp;#34;,
&amp;#34;athena:GetNamespace&amp;#34;,
&amp;#34;athena:GetQueryExecutions&amp;#34;,
&amp;#34;athena:GetCatalogs&amp;#34;,
&amp;#34;athena:ListNamedQueries&amp;#34;,
&amp;#34;athena:GetNamespaces&amp;#34;,
&amp;#34;glue:GetPartition&amp;#34;,
&amp;#34;glue:GetDevEndpoints&amp;#34;,
&amp;#34;athena:GetTables&amp;#34;,
&amp;#34;athena:GetTable&amp;#34;,
&amp;#34;athena:BatchGetNamedQuery&amp;#34;,
&amp;#34;athena:BatchGetQueryExecution&amp;#34;,
&amp;#34;glue:GetJob&amp;#34;,
&amp;#34;glue:GetConnections&amp;#34;,
&amp;#34;glue:GetCrawlers&amp;#34;,
&amp;#34;glue:GetClassifiers&amp;#34;,
&amp;#34;athena:ListQueryExecutions&amp;#34;,
&amp;#34;glue:GetCatalogImportStatus&amp;#34;,
&amp;#34;athena:GetWorkGroup&amp;#34;,
&amp;#34;glue:GetConnection&amp;#34;,
&amp;#34;glue:BatchGetPartition&amp;#34;,
&amp;#34;glue:GetSecurityConfigurations&amp;#34;,
&amp;#34;glue:GetDatabases&amp;#34;,
&amp;#34;athena:ListTagsForResource&amp;#34;,
&amp;#34;glue:GetTable&amp;#34;,
&amp;#34;glue:GetDatabase&amp;#34;,
&amp;#34;s3:GetAccountPublicAccessBlock&amp;#34;,
&amp;#34;glue:GetDataflowGraph&amp;#34;,
&amp;#34;s3:ListAllMyBuckets&amp;#34;,
&amp;#34;athena:GetQueryExecution&amp;#34;,
&amp;#34;glue:GetPlan&amp;#34;,
&amp;#34;glue:GetCrawlerMetrics&amp;#34;,
&amp;#34;glue:GetJobRuns&amp;#34;
],
&amp;#34;Resource&amp;#34;: &amp;#34;*&amp;#34;
},
{
&amp;#34;Sid&amp;#34;: &amp;#34;VisualEditor1&amp;#34;,
&amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;,
&amp;#34;Action&amp;#34;: [
&amp;#34;s3:PutObject&amp;#34;,
&amp;#34;s3:GetObject&amp;#34;,
&amp;#34;s3:ListBucketMultipartUploads&amp;#34;,
&amp;#34;s3:AbortMultipartUpload&amp;#34;,
&amp;#34;s3:CreateBucket&amp;#34;,
&amp;#34;s3:ListBucket&amp;#34;,
&amp;#34;s3:GetBucketLocation&amp;#34;,
&amp;#34;s3:ListMultipartUploadParts&amp;#34;
],
&amp;#34;Resource&amp;#34;: [
&amp;#34;arn:aws:s3:::aws-athena-query-results-&amp;lt;Account ID&amp;gt;-us-east-1&amp;#34;,
&amp;#34;arn:aws:s3:::aws-athena-query-results-&amp;lt;Account ID&amp;gt;-us-east-1/*&amp;#34;
]
},
{
&amp;#34;Sid&amp;#34;: &amp;#34;VisualEditor2&amp;#34;,
&amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;,
&amp;#34;Action&amp;#34;: [
&amp;#34;s3:ListBucketByTags&amp;#34;,
&amp;#34;s3:GetLifecycleConfiguration&amp;#34;,
&amp;#34;s3:GetBucketTagging&amp;#34;,
&amp;#34;s3:GetInventoryConfiguration&amp;#34;,
&amp;#34;s3:GetObjectVersionTagging&amp;#34;,
&amp;#34;s3:ListBucketVersions&amp;#34;,
&amp;#34;s3:GetBucketLogging&amp;#34;,
&amp;#34;s3:ListBucket&amp;#34;,
&amp;#34;s3:GetAccelerateConfiguration&amp;#34;,
&amp;#34;s3:GetBucketPolicy&amp;#34;,
&amp;#34;s3:GetObjectVersionTorrent&amp;#34;,
&amp;#34;s3:GetObjectAcl&amp;#34;,
&amp;#34;s3:GetEncryptionConfiguration&amp;#34;,
&amp;#34;s3:GetBucketRequestPayment&amp;#34;,
&amp;#34;s3:GetObjectVersionAcl&amp;#34;,
&amp;#34;s3:GetObjectTagging&amp;#34;,
&amp;#34;s3:GetMetricsConfiguration&amp;#34;,
&amp;#34;s3:GetBucketPublicAccessBlock&amp;#34;,
&amp;#34;s3:GetBucketPolicyStatus&amp;#34;,
&amp;#34;s3:ListBucketMultipartUploads&amp;#34;,
&amp;#34;s3:GetBucketWebsite&amp;#34;,
&amp;#34;s3:GetBucketVersioning&amp;#34;,
&amp;#34;s3:GetBucketAcl&amp;#34;,
&amp;#34;s3:GetBucketNotification&amp;#34;,
&amp;#34;s3:GetReplicationConfiguration&amp;#34;,
&amp;#34;s3:ListMultipartUploadParts&amp;#34;,
&amp;#34;s3:GetObject&amp;#34;,
&amp;#34;s3:GetObjectTorrent&amp;#34;,
&amp;#34;s3:GetBucketCORS&amp;#34;,
&amp;#34;s3:GetAnalyticsConfiguration&amp;#34;,
&amp;#34;s3:GetObjectVersionForReplication&amp;#34;,
&amp;#34;s3:GetBucketLocation&amp;#34;,
&amp;#34;s3:GetObjectVersion&amp;#34;
],
&amp;#34;Resource&amp;#34;: [
&amp;#34;arn:aws:s3:::&amp;lt;S3 CUR Bucket&amp;gt;/*&amp;#34;,
&amp;#34;arn:aws:s3:::&amp;lt;S3 CUR Bucket&amp;gt;&amp;#34;
]
}
]
}</description></item><item><title/><link>https://wellarchitectedlabs.com/cost/300_labs/300_splitting_sharing_cur_access/code/s3_bucket_policy/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://wellarchitectedlabs.com/cost/300_labs/300_splitting_sharing_cur_access/code/s3_bucket_policy/</guid><description>Bucket policy for member/linked account access to CUR files
NOTE: Replace the Account ID [Sub-Account ID] with your own account ID, and the bucket name [S3 Bucket Name] with your bucket name.
{ &amp;#34;Version&amp;#34;: &amp;#34;2008-10-17&amp;#34;, &amp;#34;Id&amp;#34;: &amp;#34;Policy1335892530063&amp;#34;, &amp;#34;Statement&amp;#34;: [ { &amp;#34;Sid&amp;#34;: &amp;#34;Stmt1335892150622&amp;#34;, &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Principal&amp;#34;: { &amp;#34;AWS&amp;#34;: &amp;#34;arn:aws:iam::386209384616:root&amp;#34; }, &amp;#34;Action&amp;#34;: [ &amp;#34;s3:GetBucketAcl&amp;#34;, &amp;#34;s3:GetBucketPolicy&amp;#34; ], &amp;#34;Resource&amp;#34;: &amp;#34;arn:aws:s3:::[S3 Bucket Name]&amp;#34; }, { &amp;#34;Sid&amp;#34;: &amp;#34;Stmt1335892526596&amp;#34;, &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Principal&amp;#34;: { &amp;#34;AWS&amp;#34;: &amp;#34;arn:aws:iam::386209384616:root&amp;#34; }, &amp;#34;Action&amp;#34;: &amp;#34;s3:PutObject&amp;#34;, &amp;#34;Resource&amp;#34;: &amp;#34;arn:aws:s3:::[S3 Bucket Name]/*&amp;#34; }, { &amp;#34;Sid&amp;#34;: &amp;#34;Stmt1546900919345&amp;#34;, &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Principal&amp;#34;: { &amp;#34;AWS&amp;#34;: &amp;#34;arn:aws:iam::[Sub-Account ID]:root&amp;#34; }, &amp;#34;Action&amp;#34;: &amp;#34;s3:ListBucket&amp;#34;, &amp;#34;Resource&amp;#34;: &amp;#34;arn:aws:s3:::[S3 Bucket Name]&amp;#34; }, { &amp;#34;Sid&amp;#34;: &amp;#34;Stmt1546901049588&amp;#34;, &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Principal&amp;#34;: { &amp;#34;AWS&amp;#34;: &amp;#34;arn:aws:iam::[Sub-Account ID]:root&amp;#34; }, &amp;#34;Action&amp;#34;: &amp;#34;s3:GetObject&amp;#34;, &amp;#34;Resource&amp;#34;: &amp;#34;arn:aws:s3:::[S3 Bucket Name]/*&amp;#34; } ] }</description></item><item><title/><link>https://wellarchitectedlabs.com/cost/300_labs/300_splitting_sharing_cur_access/code/s3linkedputacl/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://wellarchitectedlabs.com/cost/300_labs/300_splitting_sharing_cur_access/code/s3linkedputacl/</guid><description>Here is the Lambda function to re-write object ACLs. It is triggered by an S3 Event, reads the folder from the object - and then applies the required object ACL: FULL_CONTROL for the owner, READ for the sub account.
Edit the following fields in the code below:
folder1: The name of the folder where new files will be placed Owner Account Name: The owner account name - the account email without the @companyname, they will get FULL_CONTROL permissions Owner Canonical ID: The owner canonical ID, to get the Canonical ID, refer to: https://docs.</description></item><item><title/><link>https://wellarchitectedlabs.com/cost/300_labs/300_splitting_sharing_cur_access/code/sub_account_split/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://wellarchitectedlabs.com/cost/300_labs/300_splitting_sharing_cur_access/code/sub_account_split/</guid><description>Below is the code for the lambda function.
You will need to modify the following variable:
athena_output: This is where Athena puts output data, this is typically the management/payer Account ID, which is the default folder for Athena output queries bucketname: This is the output bucket for the Athena queries You will need to modify the following arrays, the order is important - the first folder in the subfolder array, will be given the permissions of the first element of the S3ObjectPolicies array.</description></item><item><title/><link>https://wellarchitectedlabs.com/cost/300_labs/300_splitting_sharing_cur_access/code/subacctsplit_role/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://wellarchitectedlabs.com/cost/300_labs/300_splitting_sharing_cur_access/code/subacctsplit_role/</guid><description>Review the policy below, and use it as a starting point to create your policy for the Lambda fuction.
The following fields will need to be changed:
Output bucket: The S3 bucket that will contain the output from the Athena queries Account ID: the management/payer account ID Source bucket: the location of the original CUR files in the management/payer { &amp;#34;Version&amp;#34;: &amp;#34;2012-10-17&amp;#34;, &amp;#34;Statement&amp;#34;: [ { &amp;#34;Sid&amp;#34;: &amp;#34;VisualEditor0&amp;#34;, &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Action&amp;#34;: [ &amp;#34;athena:StartQueryExecution&amp;#34;, &amp;#34;s3:DeleteObjectVersion&amp;#34;, &amp;#34;athena:GetQueryResults&amp;#34;, &amp;#34;s3:ListBucket&amp;#34;, &amp;#34;athena:GetNamedQuery&amp;#34;, &amp;#34;logs:PutLogEvents&amp;#34;, &amp;#34;athena:ListQueryExecutions&amp;#34;, &amp;#34;athena:ListNamedQueries&amp;#34;, &amp;#34;s3:PutObject&amp;#34;, &amp;#34;s3:GetObject&amp;#34;, &amp;#34;logs:CreateLogStream&amp;#34;, &amp;#34;athena:GetQueryExecution&amp;#34;, &amp;#34;s3:DeleteObject&amp;#34; ], &amp;#34;Resource&amp;#34;: [ &amp;#34;arn:aws:s3:::(output bucket)/*&amp;#34;, &amp;#34;arn:aws:logs:us-east-1:(account ID):log-group:/aws/lambda/SubAcctSplit:*&amp;#34;, &amp;#34;arn:aws:athena:*:*:workgroup/*&amp;#34; ] }, { &amp;#34;Sid&amp;#34;: &amp;#34;VisualEditor1&amp;#34;, &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Action&amp;#34;: &amp;#34;s3:ListBucket&amp;#34;, &amp;#34;Resource&amp;#34;: &amp;#34;arn:aws:s3:::*&amp;#34; }, { &amp;#34;Sid&amp;#34;: &amp;#34;VisualEditor2&amp;#34;, &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Action&amp;#34;: [ &amp;#34;glue:GetDatabase&amp;#34;, &amp;#34;glue:CreateTable&amp;#34;, &amp;#34;glue:GetPartitions&amp;#34;, &amp;#34;glue:GetPartition&amp;#34;, &amp;#34;glue:DeleteTable&amp;#34;, &amp;#34;glue:GetTable&amp;#34; ], &amp;#34;Resource&amp;#34;: &amp;#34;*&amp;#34; }, { &amp;#34;Sid&amp;#34;: &amp;#34;VisualEditor3&amp;#34;, &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Action&amp;#34;: [ &amp;#34;s3:GetBucketLocation&amp;#34;, &amp;#34;s3:GetObject&amp;#34;, &amp;#34;s3:ListBucket&amp;#34;, &amp;#34;s3:ListBucketMultipartUploads&amp;#34;, &amp;#34;s3:ListMultipartUploadParts&amp;#34;, &amp;#34;s3:AbortMultipartUpload&amp;#34;, &amp;#34;s3:CreateBucket&amp;#34;, &amp;#34;s3:PutObject&amp;#34; ], &amp;#34;Resource&amp;#34;: [ &amp;#34;arn:aws:s3:::aws-athena-query-results-us-east-1-(account ID)/*&amp;#34;, &amp;#34;arn:aws:s3:::aws-athena-query-results-us-east-1-(account ID)&amp;#34; ] }, { &amp;#34;Sid&amp;#34;: &amp;#34;VisualEditor4&amp;#34;, &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Action&amp;#34;: [ &amp;#34;s3:GetObject&amp;#34;, &amp;#34;s3:ListBucket&amp;#34; ], &amp;#34;Resource&amp;#34;: &amp;#34;arn:aws:s3:::(source bucket)/*&amp;#34; }, { &amp;#34;Sid&amp;#34;: &amp;#34;VisualEditor5&amp;#34;, &amp;#34;Effect&amp;#34;: &amp;#34;Allow&amp;#34;, &amp;#34;Action&amp;#34;: &amp;#34;logs:CreateLogGroup&amp;#34;, &amp;#34;Resource&amp;#34;: &amp;#34;arn:aws:logs:us-east-1:(account ID):*&amp;#34; } ] }</description></item></channel></rss>